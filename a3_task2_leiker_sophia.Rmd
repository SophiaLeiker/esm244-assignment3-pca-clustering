---
title: 'Assignment 3: Task 2 - Agglomerative hierarchical clustering'
author: "Sophia Leiker"
date: "2/16/2022"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(NbClust)
library(cluster)
library(factoextra)
library(dendextend)
library(ggdendro)
library(here)
library(janitor)
```

## 1. Introduction

This report will use hierarchical clustering by complete linkage to create a dendrogram showing multivariate clustering for water chemistry by site


**Data Source:** SBC LTER: Stream chemistry in the Santa Barbara Coastal drainage area, ongoing since 2000
Creators: Santa Barbara Coastal LTER, & Melack, John M
Citation: Santa Barbara Coastal LTER and J. Melack. 2019. SBC LTER: Land: Stream chemistry in the Santa Barbara Coastal drainage area, ongoing since 2000 ver 16. [Environmental Data Initiative](https://doi.org/10.6073/pasta/67a558a24ceed9a0a5bf5e46ab841174). Meta data including metrics used for each variable and data collection methods can be found [here](https://portal.edirepository.org/nis/metadataviewer?packageid=knb-lter-sbc.6.16). This data package contains stream water chemistry measurements taken in Santa Barbara area watersheds, beginning in 2000. Stream water samples are collected weekly during non-storm flows in winter, and bi-weekly during summer.

Some variables of interest include:

- `Total Dissolved Nitrogen uM`
- `Total Dissolved Phosphorus uM`
- `Total Particulate Carbon micromolesPerLiter`
- `Total Particulate Nitrogen micromolesPerLiter`
- `Total Suspended Solids (milligramPerLiter)`


```{r}
# Reading in the data
stream <- read_csv(here("data", "sbc_lter_registered_stream_chemistry.csv")) %>% 
  clean_names()
```


***
## 2. Data Wrangling

- Converting -999 values to NA
- Grouping by `site_code`
- Taking the mean of each of the observations and grouping them by site 
- Dropping the sites with some NA values as that would not lead to an accurate clustering assessment. This is because if we include the sites with some (or many) variables listed with NAs and then cluster those with sites, we could be comparing and clustering sites with only a few variables listed, with those with all the variables listed. This potentially could lead to clusters which are not accurately reflecting the collected data. 

```{r}
stream[stream==-999]<-NA

stream_site <- stream %>% 
  select(-timestamp_local) %>% 
  group_by(site_code) %>% 
  summarize(
    "Ammonium" = mean(nh4_u_m, na.rm = TRUE),
    "Nitrate" = mean(no3_u_m, na.rm = TRUE),
    "Phosphorous" = mean(po4_u_m, na.rm = TRUE),
    "Dissolved nitrogen" = mean(tdn_u_m, na.rm = TRUE),
    "Dissolved phosphorous" = mean(tdp_u_m, na.rm = TRUE),
    "Particulate carbon" = mean(tpc_u_m, na.rm = TRUE),
    "Particulate nitrogen" = mean(tpn_u_m, na.rm = TRUE),
    "Particulate phosphorous" = mean(tpp_u_m, na.rm = TRUE),
    "Suspended solids" = mean(tss_mgper_liter, na.rm = TRUE),
    "Specific conductivity" = mean(spec_cond_u_spercm, na.rm = TRUE)
  ) %>% 
  filter(site_code %in% c("AB00", "AT07", "GV01", "HO00", "MC00", "MC06", "ON02", "RG01", "RS02" ))
```

Scaling the data, removing the site code

```{r}
stream_site_scaled <- stream_site %>% 
  select(-site_code) %>% 
  scale()
  
```

***

## 3. Dendrogram

### A. Complete Linkage

```{r}
#Adding row names back in from the original dataset
rownames(stream_site_scaled) <- stream_site$site_code

#creating new dist dataframe
stream_dist <- dist(stream_site_scaled, method = 'euclidean') 
 
### Hierarchical clustering (complete linkage)
#giving it the distance matrix
stream_hc_complete <- hclust(stream_dist, method = "complete")
 
### Plot it (base plot):
plot(stream_hc_complete, cex = 0.6, hang = -1,
     main = "Cluster Dendrogram Illustrating Water Chemistry by Site (Complete)",
     sub = "Data from: Santa Barbara Coastal LTER and J. Melack. 2019",
     xlab = "Stream Site",
     ylab = "Height")

```

**Figure 1**: Cluster dendrogram for illustrating water chemistry by site using complete linkage (clusters are merged by the smallest *maximum* distance between two observations in distinct clusters).

### B. Single Linkage 

```{r}

### Hierarchical clustering (complete linkage)
#giving it the distance matrix
stream_hc_single <- hclust(stream_dist, method = "single")
 
### Plot it (base plot):
plot(stream_hc_single, cex = 0.6, hang = -1,
     main = "Cluster Dendrogram Illustrating Water Chemistry by Site (Single)",
     sub = "Data from: Santa Barbara Coastal LTER and J. Melack. 2019",
     xlab = "Stream Site",
     ylab = "Height")
```

**Figure 2**: Cluster dendrogram for illustrating water chemistry by site using single linkage (single linkage clusters are merged by the *smallest* distance between observations in separate clusters)


```{r}
# Convert to class dendrogram 
dend_complete <- as.dendrogram(stream_hc_complete)
dend_simple <- as.dendrogram(stream_hc_single)
```

Making a tanglegram:
```{r}
#make a tanglegram
tanglegram(dend_complete, dend_simple, main = "Tanglegram: Single vs Complete Linkage", lab.cex = 1, common_subtrees_color_branches = TRUE, lwd = 2.0, edge.lwd = 2.5)
```

**Figure 3**: Tanglegram illustrating how single versus complete linkage changes the clustering output. The left side of this tanglegram illustrates clustering using complete linkage, the right illsutrates tanglegram using single linkage. Pink illistrates where there is overlap in clustering between both cluster methods. 

***
## 4. Summary
- As seen in the tanglegram, there is similar clustering for the sites `MC00`, `AB00`, `MC06`, and `AT07` when using complete linkage and single linkage. 
- `RG01` is closely tied to the the cluster containing `MC00`, `AB00`, `MC06`, and `AT07` in the complete linkage scenario, but not closely located to that grouping when using the single linkage method. This would be an important site to further look into the comparison of stream chemistry related to this group
- The complete clustering method breaks the sites into two main groups, with `ON02` as an outlier.
- The single clustering method has clusters that are integrating one or two new streams for each cluster step rather than separating them out into specific large groupings. This would reflect the idea that for single linkage performs well on non-globular data, does not perform well on noisy data while average and complete linkage is good for well defined spherical clusters
- `ON02` is an outlier for both the complete and single linkage methods, which may indicate that this site has stream chemistry that is most different from all the other sites included in analysis
- More analysis should be done to assess the stream chemistry of the streams that were dropped due to having NA values to see how the integration of these streams might change the breakdown of the clusters 



***

## 5. Data Citation

Data source: Santa Barbara Coastal LTER and J. Melack. 2019. SBC LTER: Land: Stream chemistry in the Santa Barbara Coastal drainage area, ongoing since 2000 ver 16. [Environmental Data Initiative](https://doi.org/10.6073/pasta/67a558a24ceed9a0a5bf5e46ab841174)

## END TASK




